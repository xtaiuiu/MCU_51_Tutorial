C51 COMPILER V9.57.0.0   MAIN                                                              01/22/2026 16:45:18 PAGE 1   


C51 COMPILER V9.57.0.0, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN main.OBJ
COMPILER INVOKED BY: d:\Keil_v5\C51\BIN\C51.EXE main.c OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEXTEND

line level    source

   1          #include <reg52.h>
   2          #include "music_tone.h"
   3          
   4          sbit BEEP = P2^5;
   5          
   6          typedef unsigned int  u16;
   7          typedef unsigned char u8;
   8          
   9          /* ================= 音高相关（Timer1） ================= */
  10          
  11          u8 TH_reload;
  12          u8 TL_reload;
  13          
  14          /* C 调 1~7（12MHz 晶振，近似值） */
  15          u8 TH_arr[] = {0xF8, 0xF9, 0xFA, 0xFA, 0xFB, 0xFB, 0xFC};
  16          u8 TL_arr[] = {0x8C, 0x5B, 0x15, 0x67, 0x04, 0x90, 0x0C};
  17          
  18          /* ================= 音长相关（Timer0） ================= */
  19          
  20          volatile u16 tick_cnt = 0;
  21          u16 note_len_ms = 0;
  22          
  23          /* 四分音符时长（整体速度控制） */
  24          #define BEAT_MS 500   // 可改：300 快，700 慢
  25          
  26          /* ================= Timer1：产生音高 ================= */
  27          
  28          void timer1_ISR(void) interrupt 3
  29          {
  30   1          BEEP = ~BEEP;
  31   1          TH1 = TH_reload;
  32   1          TL1 = TL_reload;
  33   1      }
  34          
  35          /* ================= Timer0：1ms 节拍 ================= */
  36          
  37          void timer0_ISR(void) interrupt 1
  38          {
  39   1          TH0 = 0xFC;
  40   1          TL0 = 0x18;   // 1ms @12MHz
  41   1      
  42   1          if (++tick_cnt >= note_len_ms)
  43   1          {
  44   2              TR1 = 0;      // 停止发声
  45   2              TR0 = 0;      // 停止节拍
  46   2              tick_cnt = 0;
  47   2          }
  48   1      }
  49          
  50          /* ================= 播放一个音符 ================= */
  51          
  52          void play_one_tone(u8 tone, u16 duration_ms)
  53          {
  54   1          EA = 0;
  55   1          TH_reload = TH_arr[tone - 1];
C51 COMPILER V9.57.0.0   MAIN                                                              01/22/2026 16:45:18 PAGE 2   

  56   1          TL_reload = TL_arr[tone - 1];
  57   1          tick_cnt = 0;
  58   1          note_len_ms = duration_ms;
  59   1          EA = 1;
  60   1      
  61   1          TR1 = 1;   // 启动音高定时器
  62   1          TR0 = 1;   // 启动节拍定时器
  63   1      
  64   1          while (TR0);   // 等待音符播放结束
  65   1      }
  66          
  67          void delay_mu_s(u16 mu_s)
  68          {
  69   1              while(mu_s--);
  70   1      }
  71          
  72          /* ================= 主函数 ================= */
  73          
  74          void main(void)
  75          {
  76   1          u16 i = 0;
  77   1              char * song =  twinkle;
  78   1              u8 len = sizeof(twinkle)/sizeof(twinkle[0]);
  79   1      
  80   1          TMOD = 0x11;   // Timer0、Timer1 均为模式1
  81   1          EA  = 1;
  82   1          ET0 = 1;
  83   1          ET1 = 1;
  84   1              
  85   1      
  86   1          while (1)
  87   1          {
  88   2                      for(i = 0; i < len; i++)
  89   2                      {
  90   3                              if (song[i] > 0)
  91   3                      play_one_tone(song[i], BEAT_MS);
  92   3                  else
  93   3                      play_one_tone(-song[i], BEAT_MS * 2);
  94   3                      }
  95   2                      delay_mu_s(5000000);
  96   2          }
  97   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    219    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     80       6
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
